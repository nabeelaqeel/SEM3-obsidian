## Transaction Management and Concurrency Control

### Transaction
-  Logical unit of work that must be entirely completed or aborted
- Consists of:
	- SELECT statement 
	- Series of related UPDATE statements
	- Series of INSERT statements
	- Combination of SELECT, UPDATE, and INSERT statements
-  `Consistent database state`: All data integrity constraints are satisfied
	- Must begin with the database in a known consistent state to ensure consistency
- Formed by two or more database requests
	- `Database requests`: Equivalent of a single SQL statement in an application program or transaction
- Consists of a single SQL statement or a collection of related SQL statements

### Evaluating Transaction Results
- Not all transactions update database
	- SQL code represents a transaction because it accesses a database
- Improper or incomplete transactions can have devastating effect on database integrity
	- Users can define enforceable constraints based on business rules
	- Other integrity rules are automatically enforced by the DBMS

### Transaction Properties
![](../images/Pasted%20image%2020250202173955.png)

### Transaction Management with SQL
- SQL statements that provide transaction support
	- COMMIT 
	- ROLLBACK
- Transaction sequence must continue until:
	- COMMIT statement is reached
	- ROLLBACK statement is reached
	- End of program is reached
	- Program is abnormally terminated

### Transaction Log
- Keeps track of all transactions that update the database
- DBMS uses the information stored in a log for:
	- Recovery requirement triggered by a ROLLBACK statement
	- A program’s abnormal termination
	- A system failure

### Concurrency Control
- Coordination of the simultaneous transactions execution in a multiuser database 
system
- Objective - Ensures serializability of transactions in a multiuser database environment

### Problems in Concurrency Control
![](../images/Pasted%20image%2020250202174159.png)

### The Scheduler
- Establishes the order in which the operations are executed within concurrent transactions 
	- Interleaves the execution of database operations to ensure serializability and isolation of transactions
- Based on concurrent control algorithms to determine the appropriate order
- Creates serialization schedule 
	- `Serializable schedule`: Interleaved execution of transactions yields the same results as the serial execution of the transactions

### Concurrency Control with Locking Methods
- Locking methods - Facilitate isolation of data items used in concurrently executing transactions 
- `Lock`: Guarantees exclusive use of a data item to a current transaction
- `Pessimistic locking`: Use of locks based on the assumption that conflict between transactions is likely
- `Lock manager`: Responsible for assigning and policing the locks used by the transactions

### Lock Granularity
- Indicates the level of lock use
- Levels of locking 
	- Database-level lock
	- Table-level lock
	- Page-level lock
		- Page or diskpage: Directly addressable section of a disk
	- Row-level lock
	- Field-level lock

### Figure 10.3 - Database-Level Locking Sequence
![](../images/Pasted%20image%2020250202174450.png)


### Figure 10.4 - An Example of a Table-Level Lock
![](../images/Pasted%20image%2020250202174510.png)

### Figure 10.5 - An Example of a Page-Level Lock
![](../images/Pasted%20image%2020250202174523.png)

### Figure 10.6 - An Example of a Row-Level Lock
![](../images/Pasted%20image%2020250202174539.png)

### Lock Types
![](../images/Pasted%20image%2020250202174559.png)

### Problems in Using Locks
- Resulting transaction schedule might not be serializable
- Schedule might create deadlocks


### Two-Phase Locking (2PL)
- Defines how transactions acquire and relinquish locks
- Guarantees serializability but does not prevent deadlocks 
- Phases
	- `Growing phase` - Transaction acquires all required locks without unlocking any data
	- `Shrinking phase` - Transaction releases all locks and cannot obtain any new lock
- Governing rules
	- Two transactions cannot have conflicting locks
	- No unlock operation can precede a lock operation in the same transaction
	- No data are affected until all locks are obtained

### Figure 10.7 - Two-Phase Locking Protocol
![](../images/Pasted%20image%2020250202174731.png)

### Deadlocks
- Occurs when two transactions wait indefinitely for each other to unlock data
	- Known as deadly embrace
- Control techniques
	- Deadlock prevention 
	- Deadlock detection 
	- Deadlock avoidance 
- Choice of deadlock control method depends on database environment

### Table 10.13 - How a Deadlock Condition is Created
![](../images/Pasted%20image%2020250202174828.png)

### Time Stamping
- Assigns global, unique time stamp to each transaction
	- Produces explicit order in which transactions are submitted to DBMS
- Properties
	- `Uniqueness`: Ensures no equal time stamp values exist
	- `Monotonicity`: Ensures time stamp values always increases
- Disadvantages
	- Each value stored in the database requires two additional stamp fields
	- Increases memory needs
	- Increases the database’s processing overhead
	- Demands a lot of system resources

### Table 10.14 - Wait/Die and Wound/Wait Concurrency Control Schemes
![](../images/Pasted%20image%2020250202174933.png)

### Concurrency Control with Optimistic Methods
- Optimistic approach: Based on the assumption that the majority of database operations do not conflict
	- Does not require locking or time stamping techniques
	- Transaction is executed without restrictions until it is committed

### Phases of Optimistic Approach
![](../images/Pasted%20image%2020250202175015.png)

### Table 10.15 - Transaction Isolation Levels
![](../images/Pasted%20image%2020250202175027.png)


### Database Recovery Management 
- Database recovery: Restores database from a given state to a previously consistent state
- Recovery transactions are based on the atomic transaction property
	- Atomic transaction property: All portions of a transaction must be treated as a single logical unit of work
	- If transaction operation cannot be completed:
	- Transaction must be aborted
	- Changes to database must be rolled back

### Concepts that Affect Transaction Recovery
![](../images/Pasted%20image%2020250202175132.png)

### Techniques used in Transaction Recovery Procedures
![](../images/Pasted%20image%2020250202175154.png)

### Recovery Process in Deferred-Write Technique
- Identify the last check point in the transaction log
- If transaction was committed before the last check point
	- Nothing needs to be done
- If transaction was committed after the last check point
	- Transaction log is used to redo the transaction
- If transaction had a ROLLBACK operation after the last check point 
	- Nothing needs to be done

### Recovery Process in Write-Through Technique
- Identify the last checkpoint in the transaction log
- If transaction was committed before the last check point 
	- Nothing needs to be done
- If transaction was committed after the last checkpoint
	- Transaction must be redone
- If transaction had a ROLLBACK operation after the last check point 
	- Transaction log is used to ROLLBACK the operations
